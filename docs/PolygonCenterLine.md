# 多边形中心线 & 区域分割

## 一、多边形中心线

多边形中心线的提取大致可分为三步进行：

1. **提取由多边形轮廓平分线构成的骨架**
   将原多边形每条边所在直线以相同速度向内侧（即每条边的走向的左侧）平移，将多边形顶点也视为相邻两条线段的交点，记录这样的交点的轨迹作为骨架。如`PolygonCenterLine_clamping.pdf`所述。经过对比测试，最终采用`CGAL::StraightSkeleton_2`实现。

1. **从骨架中筛选中心线片段**
   对于骨架中的每一条线段，不妨设它是由$a$和$b$两条边的交点画出的，若多边形在$a$和$b$的交点处是凸的，且两边走向夹角大于等于$\frac{2}{3} \pi$（即至少形成一个等边三角形的外角），则将该线段作为中心线的片段。

1. **连接中心线片段**

   由于难以定义片段连接方式的“美观性”，将**中心线片段**连接起来的策略较为复杂，详见`include/impl/connect_segments.h`。

   连接**中心线片段**的策略可以理解为按照**骨架**中每条**轨迹**形成的先后顺序将**中心线片段**之间的每条不作为**中心线片段**的**轨迹**依次替换为若干新的**轨迹**作为**新增中心线**，使得最终得到的**中心线**转折尽可能少、尽可能正交、到两侧墙壁的距离尽可能一致。

   具体地，我们对**骨架**中每个结点按照它们形成的时间顺序进行优先队列BFS，过程中维护与每个结点相邻的所有**中心线片段**和**新增中心线**的**邻接中心线方向集合**（统一按照指向该结点的方向记录）。BFS的过程从每个**中心线片段**的起点开始（即：忽略掉那些从多边形轮廓到最近的**中心线片段**之间的那些非**中心线片段**的**轨迹**）。在BFS的过程中，每枚举到一个非**中心线片段**的**轨迹**线段，若**轨迹**两端点**方向集合**均非空，就按照局部最优策略从当前时刻该轨迹两端点的**邻接中心线方向集合**中各选出一个方向向量，将这两个方向作为该**轨迹**产生的**新增中心线**向两端延长的方向，再根据这两个方向与该**轨迹**方向的关系求得最优的连接方式；若其中一个端点**邻接中心线方向集合**为空（由于BFS起点一定是**中心线片段**，而BFS的每一步都一定会以**中心线片段 **或**新增中心线**结束，所以每个**轨迹**线段的起点的方向集合一定非空），则直接根据起点的**方向集合**与该**轨迹**方向的关系选择最优的连接方式。

   **终点方向集合为空时的连接策略和评估函数**

   令`base_v`表示当前**轨迹**的方向，`from`表示起点**方向集合**中的一个方向，两者的夹角余弦值为`Cos`。集合中的每个方向都对应求出一个**估价**和一个**候选方向**，选出集合中**估价**最高的那个**候选方向**。

   - 若`Cos`等于1或0，则直接将该**轨迹**作为答案即可，该方向具有最高的估价。
   - 若`Cos`不小于0，比较$1 - Cos^2$和$\frac{1}{2}Cos^2$的大小。
     - 若$1-Cos^2$较大，说明轨迹终点到该方向对应线段的距离足够远，作垂线不会导致离开该轨迹时的方向与`base_v`差距过大。此时将`from`（及其垂线）作为**候选方向**，将$1-Cos^2$作为估价。
     - 若$\frac{1}{2}Cos^2$较大，说明当前轨迹与`from`方向差距不大，为避免作垂线导致离开该轨迹时的方向与原方向差距过大，此时应将`base_v`直接作为**候选方向**，将$\frac{1}{2}Cos^2$作为估价。
   - 若`Cos`小于0，则**轨迹**终点到该方向对应线段的垂足落在**轨迹**起点之后，因此该方向不应继续延长。直接选择`base_v`作为**候选方向**，将`Cos`作为估价。

   确定方向后，将轨迹终点到该方向射线作垂足，将垂足作为转折点进行连接。

   **两端点方向集合均非空时的连接策略和评估函数**

   令`v0`为起点**方向集合**中的一个方向，`v1`为终点**方向集合**中的一个方向，`base_v`为当前**轨迹**方向。`Cos0` `Cos1`分别为`v0` `-v1`与`base_v`的夹角余弦，`Sin0`为`v0`与`base_v`的夹角正弦，`Sin1`为`base_v`与`-v1`的夹角正弦。
   
   - 若`Cos0`等于1或`Cos1`等于1，则两端都直接采用`base_v`方向作为候选方向，有最高的估价。
   - 否则，若`Cos0`或`Cos1`小于0，则轨迹另一端到该方向线段的垂足落在另一端之后，因此该方向不应继续延长。将余弦值小于0的方向旋转90°，使得`Cos0`和`Cos1`均不小于0，然后按照其他情况进行估价，然后将估价缩小一半。
   - 否则，若`Sin0`和`Sin1`一正一负，则可以经过该**轨迹**中点向两个方向对应线段做垂足，将两个垂足作为转折点。此时`v0`与`-v1`的方向越接近越美观，取`Cosine(v0, -v1)`作为估价。
   - 否则，两个转折点旋转方向一致，判断`v0`和`v1`两个向量的夹角：
     - 若夹角绝对值超过$\frac{2\pi}{3}$，说明两者夹角太尖锐，因此直接选择`base_v`作为**候选方向**即可，估价为`Cos0`和`Cos1`在”终点方向集合为空“的情况下对应的估价的平均值作为估价。
     - 否则，直接将`v0` `v1`延长交于一点即可。此时`v0` `v1`越接近正交越美观。
   

## 二、区域分割

输入一个`R`表示中心线上的点能覆盖的范围半径。

大致分为三步：

1. 对**中心线**与一个半径为`R`的圆求出闵可夫斯基和（即`CGAL::approximated_offset_2`。取原多边形与闵可夫斯基和的差集，表示中心线无法覆盖的区域`remainders`。（*注：若要考虑覆盖范围被障碍物遮挡的情况，须将中心线离散化为点集，然后枚举每个障碍物手动对范围进行扇面剔除，复杂程度较高。*）计算差集的凸壳`convex_remainders`。
1. 凸壳合并（`merge_opposite_ch`）。枚举`convex_remainders`，枚举中心线上的每个线段，将投影在每个线段上有重叠区域且到线段最短距离不超过线段两端点中较晚形成者到对应的轮廓边的距离的凸壳进行合并。结果仍保存在`convex_remainders`中。
1. 包围盒合并（`merge_boxes`）。求出每个`convex_remainders`的`bounding_box`存入`boxes`。将所有有重叠区域的`boxes`进行合并，将得到的包围盒与原多边形求交，在所得交集中只取包含`convex_remainders`的连通块作为**中心线不可覆盖区域**。再用原多边形对该区域求差集，得到**可覆盖区域**。

## 三、UCS分割

首先对所有**中心线**线段按照所在UCS分组。角度接近的方向可能被合并到同一个UCS中，可通过控制`eps_seg`的大小实现对精确度的控制。

用**一、多边形中心线**中求出的**骨架**将多边形分割成子平面`faces`，每个`face`取距它最近的**中心线**线段所在的UCS作为`face`的UCS。

将相邻的UCS相同的`face`合并，得到的就是UCS Partition。
